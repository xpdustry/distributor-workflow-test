name: Draft Release

on:
  workflow_dispatch:

env:
  XP_SEMVER_REGEX: "^([0-9]+)\\.([0-9]+)\\.([0-9]+)(-([a-zA-Z][0-9a-zA-Z]*)\\.([0-9]+))?(-SNAPSHOT)?$"

jobs:
  action:
    runs-on: ubuntu-latest
    steps:

      - name: "Checkout Repository"
        uses: actions/checkout@v6
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: "Setup Java 25"
        uses: actions/setup-java@v4
        with:
          java-version: "25"
          distribution: "temurin"

      - name: "Setup Gradle"
        uses: gradle/actions/setup-gradle@v4

      - name: "Validate Version"
        id: version
        run: |
          version="$(./gradlew properties -q --no-daemon | grep '^version:' | cut -d ':' -f 2 | tr -d '[:space:]')"
          if [[ ! "$version" =~ $XP_SEMVER_REGEX ]]; then
            echo "::error::Version is invalid, expected matching '$XP_SEMVER_REGEX', got '$version'" >&2
            exit 1
          fi

          git_version="v${version%-SNAPSHOT}"
          if [[ "$(git tag -l "$git_version")" != "" ]]; then
            echo "::error::'$git_version' already exists as a git tag" >&2
            exit 1
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: "Generate Draft"
        run: |
          latest_tag=$(git tag --sort=-creatordate | head -n 1)
          query="${latest_tag:+$latest_tag..}HEAD"
          work_dir=$(mktemp -d)
          trap 'rm -rf "$work_dir"' EXIT
          
          git log "$query" --format="%H|%h|%s" | while IFS='|' read -r sha short_sha summary_raw; do
            category="misc"
            summary="$summary_raw"
          
            # Improved regex for Conventional Commits
            if [[ "$summary_raw" =~ ^([a-zA-Z]+)(\([a-zA-Z0-9_-]+\))?!?:\ (.*)$ ]]; then
              category_raw="${BASH_REMATCH[1],,}"
              summary="${BASH_REMATCH[3]}"
          
              case "$category_raw" in
                feat)
                  category="feat" ;;
                fix)
                  category="fix" ;;
                chore|docs|refactor|style|test)
                  category="chore" ;;
                *)
                  category="misc" ;;
              esac
            else
              if [[ "${summary,,}" = "fix"* ]]; then
                category="fix"
              fi
            fi
          
            url="https://github.com/$GITHUB_REPOSITORY/commit/$sha"
            echo " - $summary ([\`$short_sha\`]($url))" >> "$work_dir/$category"
          done
          
          # Helper function to print sections
          append_section() {
            if [[ -f "$work_dir/$1" ]]; then
              echo "### $2"
              echo
              cat "$work_dir/$1"
              echo
            fi
          }
          
          append_section "feat"  "Features"       >> ".GENERATED_CHANGELOG.md"
          append_section "fix"   "Bugfixes"       >> ".GENERATED_CHANGELOG.md"
          append_section "chore" "Maintenance"    >> ".GENERATED_CHANGELOG.md"
          append_section "misc"  "Miscellaneous"  >> ".GENERATED_CHANGELOG.md"

      - name: "Publish Draft"
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          name: "v${{ steps.version.outputs.version }} release"
          draft: true
          body_path: ".GENERATED_CHANGELOG.md"
